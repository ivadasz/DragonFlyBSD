#include <sys/param.h>

#include <machine/intr_machdep.h>
#include <machine/msi_machdep.h>
#include <machine/msi_var.h>
#include <machine/md_var.h>

#include <machine_base/apic/apicreg.h>
#include <machine_base/apic/lapic.h>

/* MSI address */
#define	MSI_X86_ADDR_DEST		0x000ff000
#define	MSI_X86_ADDR_RH			0x00000008
# define MSI_X86_ADDR_RH_ON		0x00000008
# define MSI_X86_ADDR_RH_OFF		0x00000000
#define	MSI_X86_ADDR_DM			0x00000004
# define MSI_X86_ADDR_DM_PHYSICAL	0x00000000
# define MSI_X86_ADDR_DM_LOGICAL	0x00000004

/* MSI data */
#define	MSI_X86_DATA_TRGRMOD		IOART_TRGRMOD	/* Trigger mode. */
# define MSI_X86_DATA_TRGREDG		IOART_TRGREDG
# define MSI_X86_DATA_TRGRLVL		IOART_TRGRLVL
#define	MSI_X86_DATA_LEVEL		0x00004000	/* Polarity. */
# define MSI_X86_DATA_DEASSERT		0x00000000
# define MSI_X86_DATA_ASSERT		0x00004000
#define	MSI_X86_DATA_DELMOD		IOART_DELMOD	/* Delivery mode. */
# define MSI_X86_DATA_DELFIXED		IOART_DELFIXED
# define MSI_X86_DATA_DELLOPRI		IOART_DELLOPRI
# define MSI_X86_DATA_DELSMI		IOART_DELSMI
# define MSI_X86_DATA_DELNMI		IOART_DELNMI
# define MSI_X86_DATA_DELINIT		IOART_DELINIT
# define MSI_X86_DATA_DELEXINT		IOART_DELEXINT

#define	MSI_X86_ADDR(lapic_id) \
	(MSI_X86_ADDR_BASE | (lapic_id) << 12 | \
	 MSI_X86_ADDR_RH_OFF | MSI_X86_ADDR_DM_PHYSICAL)
#define	MSI_X86_DATA(vector) \
	(MSI_X86_DATA_TRGREDG | MSI_X86_DATA_DELFIXED | (vector))

#define IDTBOTH(x, n) IDTVEC(x##n), IDTVEC(x##_x2apic##n)

extern int x2apic_enable;

extern inthand_t
	IDTBOTH(msi_intr, 0),
	IDTBOTH(msi_intr, 1),
	IDTBOTH(msi_intr, 2),
	IDTBOTH(msi_intr, 3),
	IDTBOTH(msi_intr, 4),
	IDTBOTH(msi_intr, 5),
	IDTBOTH(msi_intr, 6),
	IDTBOTH(msi_intr, 7),
	IDTBOTH(msi_intr, 8),
	IDTBOTH(msi_intr, 9),
	IDTBOTH(msi_intr, 10),
	IDTBOTH(msi_intr, 11),
	IDTBOTH(msi_intr, 12),
	IDTBOTH(msi_intr, 13),
	IDTBOTH(msi_intr, 14),
	IDTBOTH(msi_intr, 15),
	IDTBOTH(msi_intr, 16),
	IDTBOTH(msi_intr, 17),
	IDTBOTH(msi_intr, 18),
	IDTBOTH(msi_intr, 19),
	IDTBOTH(msi_intr, 20),
	IDTBOTH(msi_intr, 21),
	IDTBOTH(msi_intr, 22),
	IDTBOTH(msi_intr, 23),
	IDTBOTH(msi_intr, 24),
	IDTBOTH(msi_intr, 25),
	IDTBOTH(msi_intr, 26),
	IDTBOTH(msi_intr, 27),
	IDTBOTH(msi_intr, 28),
	IDTBOTH(msi_intr, 29),
	IDTBOTH(msi_intr, 30),
	IDTBOTH(msi_intr, 31),
	IDTBOTH(msi_intr, 32),
	IDTBOTH(msi_intr, 33),
	IDTBOTH(msi_intr, 34),
	IDTBOTH(msi_intr, 35),
	IDTBOTH(msi_intr, 36),
	IDTBOTH(msi_intr, 37),
	IDTBOTH(msi_intr, 38),
	IDTBOTH(msi_intr, 39),
	IDTBOTH(msi_intr, 40),
	IDTBOTH(msi_intr, 41),
	IDTBOTH(msi_intr, 42),
	IDTBOTH(msi_intr, 43),
	IDTBOTH(msi_intr, 44),
	IDTBOTH(msi_intr, 45),
	IDTBOTH(msi_intr, 46),
	IDTBOTH(msi_intr, 47),
	IDTBOTH(msi_intr, 48),
	IDTBOTH(msi_intr, 49),
	IDTBOTH(msi_intr, 50),
	IDTBOTH(msi_intr, 51),
	IDTBOTH(msi_intr, 52),
	IDTBOTH(msi_intr, 53),
	IDTBOTH(msi_intr, 54),
	IDTBOTH(msi_intr, 55),
	IDTBOTH(msi_intr, 56),
	IDTBOTH(msi_intr, 57),
	IDTBOTH(msi_intr, 58),
	IDTBOTH(msi_intr, 59),
	IDTBOTH(msi_intr, 60),
	IDTBOTH(msi_intr, 61),
	IDTBOTH(msi_intr, 62),
	IDTBOTH(msi_intr, 63),
	IDTBOTH(msi_intr, 64),
	IDTBOTH(msi_intr, 65),
	IDTBOTH(msi_intr, 66),
	IDTBOTH(msi_intr, 67),
	IDTBOTH(msi_intr, 68),
	IDTBOTH(msi_intr, 69),
	IDTBOTH(msi_intr, 70),
	IDTBOTH(msi_intr, 71),
	IDTBOTH(msi_intr, 72),
	IDTBOTH(msi_intr, 73),
	IDTBOTH(msi_intr, 74),
	IDTBOTH(msi_intr, 75),
	IDTBOTH(msi_intr, 76),
	IDTBOTH(msi_intr, 77),
	IDTBOTH(msi_intr, 78),
	IDTBOTH(msi_intr, 79),
	IDTBOTH(msi_intr, 80),
	IDTBOTH(msi_intr, 81),
	IDTBOTH(msi_intr, 82),
	IDTBOTH(msi_intr, 83),
	IDTBOTH(msi_intr, 84),
	IDTBOTH(msi_intr, 85),
	IDTBOTH(msi_intr, 86),
	IDTBOTH(msi_intr, 87),
	IDTBOTH(msi_intr, 88),
	IDTBOTH(msi_intr, 89),
	IDTBOTH(msi_intr, 90),
	IDTBOTH(msi_intr, 91),
	IDTBOTH(msi_intr, 92),
	IDTBOTH(msi_intr, 93),
	IDTBOTH(msi_intr, 94),
	IDTBOTH(msi_intr, 95),
	IDTBOTH(msi_intr, 96),
	IDTBOTH(msi_intr, 97),
	IDTBOTH(msi_intr, 98),
	IDTBOTH(msi_intr, 99),
	IDTBOTH(msi_intr, 100),
	IDTBOTH(msi_intr, 101),
	IDTBOTH(msi_intr, 102),
	IDTBOTH(msi_intr, 103),
	IDTBOTH(msi_intr, 104),
	IDTBOTH(msi_intr, 105),
	IDTBOTH(msi_intr, 106),
	IDTBOTH(msi_intr, 107),
	IDTBOTH(msi_intr, 108),
	IDTBOTH(msi_intr, 109),
	IDTBOTH(msi_intr, 110),
	IDTBOTH(msi_intr, 111),
	IDTBOTH(msi_intr, 112),
	IDTBOTH(msi_intr, 113),
	IDTBOTH(msi_intr, 114),
	IDTBOTH(msi_intr, 115),
	IDTBOTH(msi_intr, 116),
	IDTBOTH(msi_intr, 117),
	IDTBOTH(msi_intr, 118),
	IDTBOTH(msi_intr, 119),
	IDTBOTH(msi_intr, 120),
	IDTBOTH(msi_intr, 121),
	IDTBOTH(msi_intr, 122),
	IDTBOTH(msi_intr, 123),
	IDTBOTH(msi_intr, 124),
	IDTBOTH(msi_intr, 125),
	IDTBOTH(msi_intr, 126),
	IDTBOTH(msi_intr, 127),
	IDTBOTH(msi_intr, 128),
	IDTBOTH(msi_intr, 129),
	IDTBOTH(msi_intr, 130),
	IDTBOTH(msi_intr, 131),
	IDTBOTH(msi_intr, 132),
	IDTBOTH(msi_intr, 133),
	IDTBOTH(msi_intr, 134),
	IDTBOTH(msi_intr, 135),
	IDTBOTH(msi_intr, 136),
	IDTBOTH(msi_intr, 137),
	IDTBOTH(msi_intr, 138),
	IDTBOTH(msi_intr, 139),
	IDTBOTH(msi_intr, 140),
	IDTBOTH(msi_intr, 141),
	IDTBOTH(msi_intr, 142),
	IDTBOTH(msi_intr, 143),
	IDTBOTH(msi_intr, 144),
	IDTBOTH(msi_intr, 145),
	IDTBOTH(msi_intr, 146),
	IDTBOTH(msi_intr, 147),
	IDTBOTH(msi_intr, 148),
	IDTBOTH(msi_intr, 149),
	IDTBOTH(msi_intr, 150),
	IDTBOTH(msi_intr, 151),
	IDTBOTH(msi_intr, 152),
	IDTBOTH(msi_intr, 153),
	IDTBOTH(msi_intr, 154),
	IDTBOTH(msi_intr, 155),
	IDTBOTH(msi_intr, 156),
	IDTBOTH(msi_intr, 157),
	IDTBOTH(msi_intr, 158),
	IDTBOTH(msi_intr, 159),
	IDTBOTH(msi_intr, 160),
	IDTBOTH(msi_intr, 161),
	IDTBOTH(msi_intr, 162),
	IDTBOTH(msi_intr, 163),
	IDTBOTH(msi_intr, 164),
	IDTBOTH(msi_intr, 165),
	IDTBOTH(msi_intr, 166),
	IDTBOTH(msi_intr, 167),
	IDTBOTH(msi_intr, 168),
	IDTBOTH(msi_intr, 169),
	IDTBOTH(msi_intr, 170),
	IDTBOTH(msi_intr, 171),
	IDTBOTH(msi_intr, 172),
	IDTBOTH(msi_intr, 173),
	IDTBOTH(msi_intr, 174),
	IDTBOTH(msi_intr, 175),
	IDTBOTH(msi_intr, 176),
	IDTBOTH(msi_intr, 177),
	IDTBOTH(msi_intr, 178),
	IDTBOTH(msi_intr, 179),
	IDTBOTH(msi_intr, 180),
	IDTBOTH(msi_intr, 181),
	IDTBOTH(msi_intr, 182),
	IDTBOTH(msi_intr, 183),
	IDTBOTH(msi_intr, 184),
	IDTBOTH(msi_intr, 185),
	IDTBOTH(msi_intr, 186),
	IDTBOTH(msi_intr, 187),
	IDTBOTH(msi_intr, 188),
	IDTBOTH(msi_intr, 189),
	IDTBOTH(msi_intr, 190),
	IDTBOTH(msi_intr, 191);

static inthand_t *msi_intr[IDT_HWI_VECTORS] = {
	&IDTVEC(msi_intr0),
	&IDTVEC(msi_intr1),
	&IDTVEC(msi_intr2),
	&IDTVEC(msi_intr3),
	&IDTVEC(msi_intr4),
	&IDTVEC(msi_intr5),
	&IDTVEC(msi_intr6),
	&IDTVEC(msi_intr7),
	&IDTVEC(msi_intr8),
	&IDTVEC(msi_intr9),
	&IDTVEC(msi_intr10),
	&IDTVEC(msi_intr11),
	&IDTVEC(msi_intr12),
	&IDTVEC(msi_intr13),
	&IDTVEC(msi_intr14),
	&IDTVEC(msi_intr15),
	&IDTVEC(msi_intr16),
	&IDTVEC(msi_intr17),
	&IDTVEC(msi_intr18),
	&IDTVEC(msi_intr19),
	&IDTVEC(msi_intr20),
	&IDTVEC(msi_intr21),
	&IDTVEC(msi_intr22),
	&IDTVEC(msi_intr23),
	&IDTVEC(msi_intr24),
	&IDTVEC(msi_intr25),
	&IDTVEC(msi_intr26),
	&IDTVEC(msi_intr27),
	&IDTVEC(msi_intr28),
	&IDTVEC(msi_intr29),
	&IDTVEC(msi_intr30),
	&IDTVEC(msi_intr31),
	&IDTVEC(msi_intr32),
	&IDTVEC(msi_intr33),
	&IDTVEC(msi_intr34),
	&IDTVEC(msi_intr35),
	&IDTVEC(msi_intr36),
	&IDTVEC(msi_intr37),
	&IDTVEC(msi_intr38),
	&IDTVEC(msi_intr39),
	&IDTVEC(msi_intr40),
	&IDTVEC(msi_intr41),
	&IDTVEC(msi_intr42),
	&IDTVEC(msi_intr43),
	&IDTVEC(msi_intr44),
	&IDTVEC(msi_intr45),
	&IDTVEC(msi_intr46),
	&IDTVEC(msi_intr47),
	&IDTVEC(msi_intr48),
	&IDTVEC(msi_intr49),
	&IDTVEC(msi_intr50),
	&IDTVEC(msi_intr51),
	&IDTVEC(msi_intr52),
	&IDTVEC(msi_intr53),
	&IDTVEC(msi_intr54),
	&IDTVEC(msi_intr55),
	&IDTVEC(msi_intr56),
	&IDTVEC(msi_intr57),
	&IDTVEC(msi_intr58),
	&IDTVEC(msi_intr59),
	&IDTVEC(msi_intr60),
	&IDTVEC(msi_intr61),
	&IDTVEC(msi_intr62),
	&IDTVEC(msi_intr63),
	&IDTVEC(msi_intr64),
	&IDTVEC(msi_intr65),
	&IDTVEC(msi_intr66),
	&IDTVEC(msi_intr67),
	&IDTVEC(msi_intr68),
	&IDTVEC(msi_intr69),
	&IDTVEC(msi_intr70),
	&IDTVEC(msi_intr71),
	&IDTVEC(msi_intr72),
	&IDTVEC(msi_intr73),
	&IDTVEC(msi_intr74),
	&IDTVEC(msi_intr75),
	&IDTVEC(msi_intr76),
	&IDTVEC(msi_intr77),
	&IDTVEC(msi_intr78),
	&IDTVEC(msi_intr79),
	&IDTVEC(msi_intr80),
	&IDTVEC(msi_intr81),
	&IDTVEC(msi_intr82),
	&IDTVEC(msi_intr83),
	&IDTVEC(msi_intr84),
	&IDTVEC(msi_intr85),
	&IDTVEC(msi_intr86),
	&IDTVEC(msi_intr87),
	&IDTVEC(msi_intr88),
	&IDTVEC(msi_intr89),
	&IDTVEC(msi_intr90),
	&IDTVEC(msi_intr91),
	&IDTVEC(msi_intr92),
	&IDTVEC(msi_intr93),
	&IDTVEC(msi_intr94),
	&IDTVEC(msi_intr95),
	&IDTVEC(msi_intr96),
	&IDTVEC(msi_intr97),
	&IDTVEC(msi_intr98),
	&IDTVEC(msi_intr99),
	&IDTVEC(msi_intr100),
	&IDTVEC(msi_intr101),
	&IDTVEC(msi_intr102),
	&IDTVEC(msi_intr103),
	&IDTVEC(msi_intr104),
	&IDTVEC(msi_intr105),
	&IDTVEC(msi_intr106),
	&IDTVEC(msi_intr107),
	&IDTVEC(msi_intr108),
	&IDTVEC(msi_intr109),
	&IDTVEC(msi_intr110),
	&IDTVEC(msi_intr111),
	&IDTVEC(msi_intr112),
	&IDTVEC(msi_intr113),
	&IDTVEC(msi_intr114),
	&IDTVEC(msi_intr115),
	&IDTVEC(msi_intr116),
	&IDTVEC(msi_intr117),
	&IDTVEC(msi_intr118),
	&IDTVEC(msi_intr119),
	&IDTVEC(msi_intr120),
	&IDTVEC(msi_intr121),
	&IDTVEC(msi_intr122),
	&IDTVEC(msi_intr123),
	&IDTVEC(msi_intr124),
	&IDTVEC(msi_intr125),
	&IDTVEC(msi_intr126),
	&IDTVEC(msi_intr127),
	&IDTVEC(msi_intr128),
	&IDTVEC(msi_intr129),
	&IDTVEC(msi_intr130),
	&IDTVEC(msi_intr131),
	&IDTVEC(msi_intr132),
	&IDTVEC(msi_intr133),
	&IDTVEC(msi_intr134),
	&IDTVEC(msi_intr135),
	&IDTVEC(msi_intr136),
	&IDTVEC(msi_intr137),
	&IDTVEC(msi_intr138),
	&IDTVEC(msi_intr139),
	&IDTVEC(msi_intr140),
	&IDTVEC(msi_intr141),
	&IDTVEC(msi_intr142),
	&IDTVEC(msi_intr143),
	&IDTVEC(msi_intr144),
	&IDTVEC(msi_intr145),
	&IDTVEC(msi_intr146),
	&IDTVEC(msi_intr147),
	&IDTVEC(msi_intr148),
	&IDTVEC(msi_intr149),
	&IDTVEC(msi_intr150),
	&IDTVEC(msi_intr151),
	&IDTVEC(msi_intr152),
	&IDTVEC(msi_intr153),
	&IDTVEC(msi_intr154),
	&IDTVEC(msi_intr155),
	&IDTVEC(msi_intr156),
	&IDTVEC(msi_intr157),
	&IDTVEC(msi_intr158),
	&IDTVEC(msi_intr159),
	&IDTVEC(msi_intr160),
	&IDTVEC(msi_intr161),
	&IDTVEC(msi_intr162),
	&IDTVEC(msi_intr163),
	&IDTVEC(msi_intr164),
	&IDTVEC(msi_intr165),
	&IDTVEC(msi_intr166),
	&IDTVEC(msi_intr167),
	&IDTVEC(msi_intr168),
	&IDTVEC(msi_intr169),
	&IDTVEC(msi_intr170),
	&IDTVEC(msi_intr171),
	&IDTVEC(msi_intr172),
	&IDTVEC(msi_intr173),
	&IDTVEC(msi_intr174),
	&IDTVEC(msi_intr175),
	&IDTVEC(msi_intr176),
	&IDTVEC(msi_intr177),
	&IDTVEC(msi_intr178),
	&IDTVEC(msi_intr179),
	&IDTVEC(msi_intr180),
	&IDTVEC(msi_intr181),
	&IDTVEC(msi_intr182),
	&IDTVEC(msi_intr183),
	&IDTVEC(msi_intr184),
	&IDTVEC(msi_intr185),
	&IDTVEC(msi_intr186),
	&IDTVEC(msi_intr187),
	&IDTVEC(msi_intr188),
	&IDTVEC(msi_intr189),
	&IDTVEC(msi_intr190),
	&IDTVEC(msi_intr191)
};

static inthand_t *msi_intr_x2apic[IDT_HWI_VECTORS] = {
	&IDTVEC(msi_intr_x2apic0),
	&IDTVEC(msi_intr_x2apic1),
	&IDTVEC(msi_intr_x2apic2),
	&IDTVEC(msi_intr_x2apic3),
	&IDTVEC(msi_intr_x2apic4),
	&IDTVEC(msi_intr_x2apic5),
	&IDTVEC(msi_intr_x2apic6),
	&IDTVEC(msi_intr_x2apic7),
	&IDTVEC(msi_intr_x2apic8),
	&IDTVEC(msi_intr_x2apic9),
	&IDTVEC(msi_intr_x2apic10),
	&IDTVEC(msi_intr_x2apic11),
	&IDTVEC(msi_intr_x2apic12),
	&IDTVEC(msi_intr_x2apic13),
	&IDTVEC(msi_intr_x2apic14),
	&IDTVEC(msi_intr_x2apic15),
	&IDTVEC(msi_intr_x2apic16),
	&IDTVEC(msi_intr_x2apic17),
	&IDTVEC(msi_intr_x2apic18),
	&IDTVEC(msi_intr_x2apic19),
	&IDTVEC(msi_intr_x2apic20),
	&IDTVEC(msi_intr_x2apic21),
	&IDTVEC(msi_intr_x2apic22),
	&IDTVEC(msi_intr_x2apic23),
	&IDTVEC(msi_intr_x2apic24),
	&IDTVEC(msi_intr_x2apic25),
	&IDTVEC(msi_intr_x2apic26),
	&IDTVEC(msi_intr_x2apic27),
	&IDTVEC(msi_intr_x2apic28),
	&IDTVEC(msi_intr_x2apic29),
	&IDTVEC(msi_intr_x2apic30),
	&IDTVEC(msi_intr_x2apic31),
	&IDTVEC(msi_intr_x2apic32),
	&IDTVEC(msi_intr_x2apic33),
	&IDTVEC(msi_intr_x2apic34),
	&IDTVEC(msi_intr_x2apic35),
	&IDTVEC(msi_intr_x2apic36),
	&IDTVEC(msi_intr_x2apic37),
	&IDTVEC(msi_intr_x2apic38),
	&IDTVEC(msi_intr_x2apic39),
	&IDTVEC(msi_intr_x2apic40),
	&IDTVEC(msi_intr_x2apic41),
	&IDTVEC(msi_intr_x2apic42),
	&IDTVEC(msi_intr_x2apic43),
	&IDTVEC(msi_intr_x2apic44),
	&IDTVEC(msi_intr_x2apic45),
	&IDTVEC(msi_intr_x2apic46),
	&IDTVEC(msi_intr_x2apic47),
	&IDTVEC(msi_intr_x2apic48),
	&IDTVEC(msi_intr_x2apic49),
	&IDTVEC(msi_intr_x2apic50),
	&IDTVEC(msi_intr_x2apic51),
	&IDTVEC(msi_intr_x2apic52),
	&IDTVEC(msi_intr_x2apic53),
	&IDTVEC(msi_intr_x2apic54),
	&IDTVEC(msi_intr_x2apic55),
	&IDTVEC(msi_intr_x2apic56),
	&IDTVEC(msi_intr_x2apic57),
	&IDTVEC(msi_intr_x2apic58),
	&IDTVEC(msi_intr_x2apic59),
	&IDTVEC(msi_intr_x2apic60),
	&IDTVEC(msi_intr_x2apic61),
	&IDTVEC(msi_intr_x2apic62),
	&IDTVEC(msi_intr_x2apic63),
	&IDTVEC(msi_intr_x2apic64),
	&IDTVEC(msi_intr_x2apic65),
	&IDTVEC(msi_intr_x2apic66),
	&IDTVEC(msi_intr_x2apic67),
	&IDTVEC(msi_intr_x2apic68),
	&IDTVEC(msi_intr_x2apic69),
	&IDTVEC(msi_intr_x2apic70),
	&IDTVEC(msi_intr_x2apic71),
	&IDTVEC(msi_intr_x2apic72),
	&IDTVEC(msi_intr_x2apic73),
	&IDTVEC(msi_intr_x2apic74),
	&IDTVEC(msi_intr_x2apic75),
	&IDTVEC(msi_intr_x2apic76),
	&IDTVEC(msi_intr_x2apic77),
	&IDTVEC(msi_intr_x2apic78),
	&IDTVEC(msi_intr_x2apic79),
	&IDTVEC(msi_intr_x2apic80),
	&IDTVEC(msi_intr_x2apic81),
	&IDTVEC(msi_intr_x2apic82),
	&IDTVEC(msi_intr_x2apic83),
	&IDTVEC(msi_intr_x2apic84),
	&IDTVEC(msi_intr_x2apic85),
	&IDTVEC(msi_intr_x2apic86),
	&IDTVEC(msi_intr_x2apic87),
	&IDTVEC(msi_intr_x2apic88),
	&IDTVEC(msi_intr_x2apic89),
	&IDTVEC(msi_intr_x2apic90),
	&IDTVEC(msi_intr_x2apic91),
	&IDTVEC(msi_intr_x2apic92),
	&IDTVEC(msi_intr_x2apic93),
	&IDTVEC(msi_intr_x2apic94),
	&IDTVEC(msi_intr_x2apic95),
	&IDTVEC(msi_intr_x2apic96),
	&IDTVEC(msi_intr_x2apic97),
	&IDTVEC(msi_intr_x2apic98),
	&IDTVEC(msi_intr_x2apic99),
	&IDTVEC(msi_intr_x2apic100),
	&IDTVEC(msi_intr_x2apic101),
	&IDTVEC(msi_intr_x2apic102),
	&IDTVEC(msi_intr_x2apic103),
	&IDTVEC(msi_intr_x2apic104),
	&IDTVEC(msi_intr_x2apic105),
	&IDTVEC(msi_intr_x2apic106),
	&IDTVEC(msi_intr_x2apic107),
	&IDTVEC(msi_intr_x2apic108),
	&IDTVEC(msi_intr_x2apic109),
	&IDTVEC(msi_intr_x2apic110),
	&IDTVEC(msi_intr_x2apic111),
	&IDTVEC(msi_intr_x2apic112),
	&IDTVEC(msi_intr_x2apic113),
	&IDTVEC(msi_intr_x2apic114),
	&IDTVEC(msi_intr_x2apic115),
	&IDTVEC(msi_intr_x2apic116),
	&IDTVEC(msi_intr_x2apic117),
	&IDTVEC(msi_intr_x2apic118),
	&IDTVEC(msi_intr_x2apic119),
	&IDTVEC(msi_intr_x2apic120),
	&IDTVEC(msi_intr_x2apic121),
	&IDTVEC(msi_intr_x2apic122),
	&IDTVEC(msi_intr_x2apic123),
	&IDTVEC(msi_intr_x2apic124),
	&IDTVEC(msi_intr_x2apic125),
	&IDTVEC(msi_intr_x2apic126),
	&IDTVEC(msi_intr_x2apic127),
	&IDTVEC(msi_intr_x2apic128),
	&IDTVEC(msi_intr_x2apic129),
	&IDTVEC(msi_intr_x2apic130),
	&IDTVEC(msi_intr_x2apic131),
	&IDTVEC(msi_intr_x2apic132),
	&IDTVEC(msi_intr_x2apic133),
	&IDTVEC(msi_intr_x2apic134),
	&IDTVEC(msi_intr_x2apic135),
	&IDTVEC(msi_intr_x2apic136),
	&IDTVEC(msi_intr_x2apic137),
	&IDTVEC(msi_intr_x2apic138),
	&IDTVEC(msi_intr_x2apic139),
	&IDTVEC(msi_intr_x2apic140),
	&IDTVEC(msi_intr_x2apic141),
	&IDTVEC(msi_intr_x2apic142),
	&IDTVEC(msi_intr_x2apic143),
	&IDTVEC(msi_intr_x2apic144),
	&IDTVEC(msi_intr_x2apic145),
	&IDTVEC(msi_intr_x2apic146),
	&IDTVEC(msi_intr_x2apic147),
	&IDTVEC(msi_intr_x2apic148),
	&IDTVEC(msi_intr_x2apic149),
	&IDTVEC(msi_intr_x2apic150),
	&IDTVEC(msi_intr_x2apic151),
	&IDTVEC(msi_intr_x2apic152),
	&IDTVEC(msi_intr_x2apic153),
	&IDTVEC(msi_intr_x2apic154),
	&IDTVEC(msi_intr_x2apic155),
	&IDTVEC(msi_intr_x2apic156),
	&IDTVEC(msi_intr_x2apic157),
	&IDTVEC(msi_intr_x2apic158),
	&IDTVEC(msi_intr_x2apic159),
	&IDTVEC(msi_intr_x2apic160),
	&IDTVEC(msi_intr_x2apic161),
	&IDTVEC(msi_intr_x2apic162),
	&IDTVEC(msi_intr_x2apic163),
	&IDTVEC(msi_intr_x2apic164),
	&IDTVEC(msi_intr_x2apic165),
	&IDTVEC(msi_intr_x2apic166),
	&IDTVEC(msi_intr_x2apic167),
	&IDTVEC(msi_intr_x2apic168),
	&IDTVEC(msi_intr_x2apic169),
	&IDTVEC(msi_intr_x2apic170),
	&IDTVEC(msi_intr_x2apic171),
	&IDTVEC(msi_intr_x2apic172),
	&IDTVEC(msi_intr_x2apic173),
	&IDTVEC(msi_intr_x2apic174),
	&IDTVEC(msi_intr_x2apic175),
	&IDTVEC(msi_intr_x2apic176),
	&IDTVEC(msi_intr_x2apic177),
	&IDTVEC(msi_intr_x2apic178),
	&IDTVEC(msi_intr_x2apic179),
	&IDTVEC(msi_intr_x2apic180),
	&IDTVEC(msi_intr_x2apic181),
	&IDTVEC(msi_intr_x2apic182),
	&IDTVEC(msi_intr_x2apic183),
	&IDTVEC(msi_intr_x2apic184),
	&IDTVEC(msi_intr_x2apic185),
	&IDTVEC(msi_intr_x2apic186),
	&IDTVEC(msi_intr_x2apic187),
	&IDTVEC(msi_intr_x2apic188),
	&IDTVEC(msi_intr_x2apic189),
	&IDTVEC(msi_intr_x2apic190),
	&IDTVEC(msi_intr_x2apic191)
};

void
msi_setup(int intr, int cpuid)
{
	if (x2apic_enable) {
		setidt(IDT_OFFSET + intr, msi_intr_x2apic[intr],
		    SDT_SYSIGT, SEL_KPL, 0, cpuid);
	} else {
		setidt(IDT_OFFSET + intr, msi_intr[intr],
		    SDT_SYSIGT, SEL_KPL, 0, cpuid);
	}
}

void
msi_map(int intr, uint64_t *addr, uint32_t *data, int cpuid)
{
	int vector, lapic_id;

	vector = IDT_OFFSET + intr;
	lapic_id = CPUID_TO_APICID(cpuid);

	*addr = MSI_X86_ADDR(lapic_id);
	*data = MSI_X86_DATA(vector);
}
